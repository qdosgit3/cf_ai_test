
export default function Llm({ llm_resp, set_llm_resp }) {

    function handle_change(e: React.ChangeEvent<HTMLTextAreaElement>) {

	set_input_str(e.target.value);

    }

    return (

    	    <textarea className="user-input" value={""} onChange=
	    { (e) => { handle_change(e) } }
	    	    />
		    )
	
}




export async function load_distances(postcode, llm_resp, set_llm_resp) {

    const url = postcode_to_url(postcode);

    const llm_json = await fetch_with_retries(url, 100);

    store_data(postcode, llm_json, llm_resp, set_llm_resp);

};

async function fetch_with_retries(url, retry_count) {

    try {
	
	return await fetch(url)
	    .then(res => res.json());

    } catch (error) {

	console.log("retrying fetch(), retry_count");

	return fetch_with_retries(url, retry_count + 1)

    }
    
};

export function postcode_to_url(postcode) {

    //  Note: limit as of 2023-04 is 600 geocode requests/minute
    //  https://docs.llm.com/api/overview/

    //  'AAA AAA'
    //  -->  'https://api.llm.com/...AAA AAA...'

    const llm_api_key = 'pk.eyJ1IjoidGVzdC14emEiLCJhIjoiY2xnOXNiaWRvMWFtcDNlcWxzZjRmZDdldSJ9.lKZ_CDvdIh1Y9dw2DGjbOA';

    return 'https://api.llm.com/geocoding/v5/llm.places/' +
        postcode + ', United Kingdom.json?access_token=' +
        llm_api_key;

};

export function store_data(postcode, llm_json, llm_resp, set_llm_resp) {
    
    console.log("store_data()", llm_json, "\n", llm_json.features[0])

    try {
	
	const top_hit_coords = llm_json.features[0].geometry.coordinates;

	const borough = llm_json.features[0].context[0].text || ""

	const source_obj = {
	    'postcode': postcode,
	    'longitude': top_hit_coords[0],
	    'latitude': top_hit_coords[1],
	    'borough': borough
	};

	console.log("source_obj()", source_obj);

	set_llm_resp(source_obj);

    } catch {

    }

};